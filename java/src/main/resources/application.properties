# Application Configuration
spring.application.name=upload_file

# Database Configuration - Fixed
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.url=jdbc:mysql://localhost:3306/upload_file?useSSL=false&createDatabaseIfNotExist=true&allowPublicKeyRetrieval=true&serverTimezone=UTC&autoReconnect=true&useUnicode=true&characterEncoding=UTF-8
spring.datasource.username=root
spring.datasource.password=admin

# For application.properties
server.tomcat.uri-encoding=UTF-8
server.servlet.encoding.charset=UTF-8
server.servlet.encoding.enabled=true
server.servlet.encoding.force=true

# HikariCP Configuration - Fixed
spring.datasource.hikari.maximum-pool-size=10
spring.datasource.hikari.minimum-idle=5
spring.datasource.hikari.idle-timeout=300000
spring.datasource.hikari.max-lifetime=1200000
spring.datasource.hikari.connection-timeout=20000
spring.datasource.hikari.leak-detection-threshold=60000
spring.datasource.hikari.validation-timeout=5000
spring.datasource.hikari.connection-init-sql=SELECT 1
spring.datasource.hikari.auto-commit=true

# Fixed JPA/Hibernate Configuration
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect
spring.jpa.properties.hibernate.format_sql=true
spring.jpa.properties.hibernate.jdbc.batch_size=20
spring.jpa.properties.hibernate.order_inserts=true
spring.jpa.properties.hibernate.order_updates=true
spring.jpa.properties.hibernate.jdbc.batch_versioned_data=true
spring.jpa.properties.hibernate.cache.use_second_level_cache=false
spring.jpa.properties.hibernate.cache.use_query_cache=false
spring.jpa.properties.hibernate.generate_statistics=false

# Transaction Configuration - Fixed
spring.jpa.properties.hibernate.current_session_context_class=org.springframework.orm.hibernate5.SpringSessionContext
spring.transaction.default-timeout=30
spring.transaction.rollback-on-commit-failure=true

# Enhanced File Upload Configuration - FIX LARGE FILE UPLOAD
spring.servlet.multipart.max-file-size=5GB
spring.servlet.multipart.max-request-size=5GB
spring.servlet.multipart.file-size-threshold=50MB
spring.servlet.multipart.location=${java.io.tmpdir}
# FIX: Content type detection
spring.servlet.multipart.resolve-lazily=false
spring.http.multipart.resolve-lazily=false

# Enhanced Async Task Execution Configuration
spring.task.execution.pool.core-size=4
spring.task.execution.pool.max-size=16
spring.task.execution.pool.queue-capacity=100
spring.task.execution.thread-name-prefix=Async-Thread-
spring.task.execution.shutdown.await-termination=true
spring.task.execution.shutdown.await-termination-period=60s
spring.task.execution.pool.keep-alive=60s
spring.task.scheduling.pool.size=2

# Enhanced Server Configuration - FIX TIMEOUT ISSUES
server.port=${SERVER_PORT}
server.tomcat.max-connections=8192
server.tomcat.threads.max=200
server.tomcat.threads.min-spare=10
server.tomcat.connection-timeout=300000
server.tomcat.keep-alive-timeout=300000
spring.mvc.async.request-timeout=300000
server.tomcat.max-keep-alive-requests=100
server.tomcat.accept-count=100
server.tomcat.max-swallow-size=500MB
server.tomcat.max-http-form-post-size=500MB

# Enhanced HTTP Configuration
server.compression.enabled=true
server.compression.mime-types=text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json,application/xml
server.compression.min-response-size=1024
server.http2.enabled=false

# FIX CORS CONFIGURATION - Add more allowed origins
cors.allowed-origins=http://localhost:3000,http://localhost:3001,http://localhost:4200,http://127.0.0.1:4200,http://localhost:8080
cors.allowed-methods=GET,POST,PUT,DELETE,OPTIONS,HEAD
cors.allowed-headers=*
cors.allow-credentials=true
cors.exposed-headers=Content-Disposition,Content-Type,Content-Length,X-Frame-Options

# FIX: Add specific headers for file operations
server.servlet.session.cookie.same-site=lax
server.servlet.session.cookie.secure=false

# Logging Configuration
logging.level.com.upload_file=DEBUG
logging.level.com.upload_file.service.OneDriveService=DEBUG
logging.level.com.upload_file.config.JwtAuthenticationFilter=INFO
logging.level.com.upload_file.common.UserIml=INFO
logging.level.com.upload_file.util.JwtUtil=INFO
logging.level.com.upload_file.controller.FileController=INFO
logging.level.com.upload_file.service.FileDBService=INFO
logging.level.com.upload_file.service.LibreOfficeService=INFO

# FIX: Add more detailed logging for JODConverter
logging.level.org.hibernate.SQL=DEBUG
logging.level.org.hibernate.type.descriptor.sql.BasicBinder=DEBUG
logging.level.org.springframework.transaction=DEBUG
logging.level.org.springframework.orm.jpa=WARN
logging.level.org.springframework.web.cors=DEBUG
logging.level.org.springframework.security=INFO
logging.level.org.jodconverter=WARN
logging.level.okhttp3.OkHttpClient=DEBUG

logging.pattern.console=%clr(%d{yyyy-MM-dd HH:mm:ss.SSS}){faint} %clr([%thread]){blue} %clr(%-5level){yellow} %clr(%logger{36}){cyan} : %msg%n
logging.pattern.file=%clr(%d{yyyy-MM-dd HH:mm:ss.SSS}){faint} %clr([%thread]){blue} %clr(%-5level){yellow} %clr(%logger{36}){cyan} : %msg%n
logging.file.name=logs/video-upload.log
logging.file.max-size=20MB
logging.file.max-history=30
logging.file.total-size-cap=1GB

management.endpoints.web.exposure.include=health,info,metrics
management.endpoint.health.show-details=always
management.prometheus.metrics.export.enabled=false
spring.autoconfigure.exclude=org.springframework.boot.actuate.autoconfigure.metrics.export.prometheus.PrometheusMetricsExportAutoConfiguration

# Enhanced Custom Application Properties
app.upload.directory=D:/videos
app.temp.directory=${java.io.tmpdir}/video-chunks
app.max.db.size=26214400
app.chunk.buffer.size=65536
app.stream.buffer.size=131072
app.flush.interval=524288

# Enhanced File Conversion Configuration
app.converted.directory=D:/converted_files
app.converted.expire-hours=1

# File cleanup configuration
app.file-cleanup.enabled=true

# File cleanup scheduling
app.file-cleanup.converted-files=true
app.file-cleanup.schedule-cron=0 0 */2 * * *

# Development profile - disable office web viewer
app.office.web-viewer.enabled=false
app.office.force-download=true
app.office.conversion.enabled=true
app.office.conversion.max-file-size=10485760
app.office.conversion.timeout=30000

# Video streaming timeout settings
app.streaming.timeout=300000
app.streaming.range-support=true
app.streaming.video.chunk-limit=10485760

# IFrame allowed origins - Add more allowed origins
app.base-url=${APP_URL}
#app.additional-origins=https://localhost:8443,https://api.yourdomain.com

# OneDrive Configuration
onedrive.redirect-uri=${APP_URL}/auth/callback
onedrive.scope=https://graph.microsoft.com/Files.ReadWrite offline_access

# OneDrive Upload Settings
onedrive.upload.chunk-size=10485760
onedrive.upload.retry-count=3
onedrive.upload.timeout=300000

# OneDrive streaming settings
onedrive.streaming.timeout=300000
onedrive.streaming.chunk-size=5242880

# OneDrive API Configuration
azure.client-id=${AZURE_CLIENT_ID}
azure.client-secret=${AZURE_CLIENT_SECRET}
azure.tenant-id=${AZURE_TENANT_ID}
azure.user-id=${AZURE_USER_ID}

# Optional: For specific site/drive access
azure.site-id=
azure.drive-id=

# Spring Cache Configuration
spring.cache.type=caffeine
spring.cache.caffeine.spec=maximumSize=500,expireAfterWrite=1h
spring.cache.cache-names[0]=onedrive-access-token
spring.cache.cache-names[1]=onedrive-download-url
spring.cache.cache-names[2]=onedrive-file-size

# JWT Configuration
jwt.secret=${JWT_SECRET}
jwt.expiration=3600
jwt.refresh-expiration=86400
jwt.header=Authorization
jwt.prefix=Bearer

# Additional Security Configuration
security.require-ssl=false
security.jwt.blacklist.enabled=true

# Rate Limiting Configuration
security.rate-limit.enabled=true
security.rate-limit.requests-per-minute=60

# Additional Error Handling Configuration
server.error.whitelabel.enabled=false
server.error.include-message=always
server.error.include-binding-errors=always
server.error.include-stacktrace=on_param
server.error.include-exception=false

# Temporary file cleanup
spring.servlet.multipart.enabled=true

# LibreOffice Configuration - Updated paths for Windows
libreoffice.path=C:\\Program Files\\LibreOffice\\program
libreoffice.process-timeout=120000
libreoffice.process-retry-interval=5000
libreoffice.max-tasks-per-process=5
libreoffice.auto-restart=true
libreoffice.task-queue-timeout=60000
libreoffice.skip-version-check=false

# Additional JODConverter specific settings
jodconverter.local.enabled=true
jodconverter.local.office-home=C:\\Program Files\\LibreOffice
jodconverter.local.process-timeout=120000
jodconverter.local.process-retry-interval=5000
jodconverter.local.max-tasks-per-process=5
jodconverter.local.task-queue-timeout=60000
jodconverter.local.task-execution-timeout=90000
jodconverter.local.office-startup-timeout=90000
jodconverter.local.office-shutdown-timeout=30000
jodconverter.local.port-numbers=2002

# Memory optimization for LibreOffice
jodconverter.local.working-dir=${java.io.tmpdir}/jodconverter
jodconverter.local.template-profile-dir=${java.io.tmpdir}/jodconverter_profile