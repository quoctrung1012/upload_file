<!DOCTYPE html>
<html lang="en">
<head>
  <title>Dashboard</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body class="dashboard-body">
<div class="header">
  <div class="header-content">
    <div class="logo">Dashboard</div>
    <div class="user-info">
      <p class="welcome-text">Welcome, <span id="username">Loading...</span>!</p>
      <button id="logoutBtn" class="btn-logout">Logout</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="loading-spinner" id="loadingSpinner">
    üîÑ Loading your dashboard...
  </div>

  <div id="dashboardContent" style="display: none;">
    <h1 class="dashboard-title">Your Dashboard</h1>

    <div class="success-message">
      üéâ You are logged in successfully!
    </div>

    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-number">24</div>
        <div class="stat-label">Active Projects</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">1,547</div>
        <div class="stat-label">Total Views</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">89%</div>
        <div class="stat-label">Success Rate</div>
      </div>
      <div class="stat-card">
        <div class="stat-number">12</div>
        <div class="stat-label">Team Members</div>
      </div>
    </div>

    <div class="dashboard-grid">
      <div class="dashboard-card">
        <div class="card-icon">üìÅ</div>
        <h3 class="card-title">File Manager</h3>
        <p class="card-description">Manage your files with advanced upload and preview features.</p>
        <button id="openFileManagerBtn" class="btn btn-primary">Open File Manager</button>
      </div>

      <div class="dashboard-card">
        <div class="card-icon">üìä</div>
        <h3 class="card-title">Analytics</h3>
        <p class="card-description">View detailed analytics and insights about your projects and performance metrics.</p>
      </div>

      <div class="dashboard-card">
        <div class="card-icon">üë•</div>
        <h3 class="card-title">Team Management</h3>
        <p class="card-description">Manage your team members, assign roles, and collaborate effectively on projects.</p>
      </div>

      <div class="dashboard-card">
        <div class="card-icon">‚öôÔ∏è</div>
        <h3 class="card-title">Settings</h3>
        <p class="card-description">Customize your account settings, preferences, and notification options.</p>
      </div>

      <div class="dashboard-card">
        <div class="card-icon">üìù</div>
        <h3 class="card-title">Reports</h3>
        <p class="card-description">Generate comprehensive reports and export data for analysis and presentations.</p>
      </div>

      <div class="dashboard-card">
        <div class="card-icon">üîí</div>
        <h3 class="card-title">Security</h3>
        <p class="card-description">Monitor security settings, review login activity, and manage access permissions.</p>
      </div>

      <div class="dashboard-card">
        <div class="card-icon">üì±</div>
        <h3 class="card-title">Mobile App</h3>
        <p class="card-description">Download our mobile app to access your dashboard on the go from any device.</p>
      </div>

    </div>
  </div>
</div>

<script>
  // Global variable ƒë·ªÉ l∆∞u th√¥ng tin user
  window.userData = null;

  // Function ƒë·ªÉ redirect v·ªÅ login
  function redirectToLogin(message = 'Please login to continue') {
    // X√≥a t·∫•t c·∫£ th√¥ng tin trong sessionStorage
    sessionStorage.clear();

    // Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu c·∫ßn
    if (message !== 'Please login to continue') {
      alert(message);
    }

    // Chuy·ªÉn h∆∞·ªõng v·ªÅ login
    window.location.href = '/login';
  }

  // Function ƒë·ªÉ validate token v·ªõi server
  async function validateTokenWithServer(token) {
    try {
      const response = await makeAuthenticatedRequest('/api/auth/validate', {
        method: 'GET',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        }
      });

      if (!response) return null; // ƒê√£ redirect login

      if (response.ok) {
        return await response.json();
      } else {
        throw new Error('Token validation failed after refresh');
      }
    } catch (error) {
      console.error('Token validation error:', error);
      throw error;
    }
  }

  // Function ƒë·ªÉ load user data - ƒê√É LO·∫†I B·ªé API VALIDATION
  async function loadUserData() {
    const loadingSpinner = document.getElementById('loadingSpinner');
    const dashboardContent = document.getElementById('dashboardContent');
    const usernameElement = document.getElementById('username');

    loadingSpinner.style.display = 'block';
    dashboardContent.style.display = 'none';

    try {
      const token = sessionStorage.getItem('authToken');
      const refreshToken = sessionStorage.getItem('refreshToken');
      const username = sessionStorage.getItem('username');

      if (!token || !refreshToken || !username) {
        throw new Error('Missing authentication data');
      }

      // Validate v·ªõi auto-refresh
      const validationResponse = await validateTokenWithServer(token);

      if (!validationResponse) return; // ƒê√£ redirect login

      if (validationResponse.username !== username) {
        throw new Error('Username mismatch');
      }

      // Update global data
      window.userData = {
        token: sessionStorage.getItem('authToken'), // C√≥ th·ªÉ ƒë√£ ƒë∆∞·ª£c refresh
        username: username,
        userId: sessionStorage.getItem('userId'),
        userRole: sessionStorage.getItem('userRole')
      };

      usernameElement.textContent = username;

      setTimeout(() => {
        loadingSpinner.style.display = 'none';
        dashboardContent.style.display = 'block';
      }, 500);

    } catch (error) {
      console.error('Failed to load user data:', error);
      loadingSpinner.style.display = 'none';
      redirectToLogin('Session expired or invalid. Please login again.');
    }
  }

  // Function ƒë·ªÉ logout - ƒê√É ƒê∆†N GI·∫¢N H√ìA
  async function logout() {
    try {
      const token = sessionStorage.getItem('authToken');

      if (token) {
        await fetch('/api/auth/logout', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          }
        });
      }
    } catch (error) {
      console.error('Logout API error:', error);
    } finally {
      // D√π c√≥ l·ªói hay kh√¥ng c≈©ng clear session v√† redirect
      sessionStorage.clear();
      window.userData = null;
      window.location.href = '/login';
    }
  }

  async function refreshAccessToken() {
    try {
      const refreshToken = sessionStorage.getItem('refreshToken');

      if (!refreshToken) {
        throw new Error('No refresh token available');
      }

      const response = await fetch('/api/auth/refresh', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ refreshToken: refreshToken })
      });

      if (response.ok) {
        const data = await response.json();

        // C·∫≠p nh·∫≠t tokens m·ªõi
        sessionStorage.setItem('authToken', data.accessToken);
        if (data.refreshToken) {
          sessionStorage.setItem('refreshToken', data.refreshToken);
        }

        console.log('Token refreshed successfully');
        return data.accessToken;
      } else {
        throw new Error('Refresh token expired or invalid');
      }
    } catch (error) {
      console.error('Token refresh failed:', error);
      throw error;
    }
  }

  async function makeAuthenticatedRequest(url, options = {}) {
    let token = sessionStorage.getItem('authToken');

    const requestOptions = {
      ...options,
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json',
        ...options.headers
      }
    };

    try {
      let response = await fetch(url, requestOptions);

      // N·∫øu token h·∫øt h·∫°n (401), th·ª≠ refresh
      if (response.status === 401) {
        console.log('Access token expired, attempting refresh...');

        try {
          // Refresh token
          const newToken = await refreshAccessToken();

          // Retry v·ªõi token m·ªõi
          requestOptions.headers['Authorization'] = 'Bearer ' + newToken;
          response = await fetch(url, requestOptions);

        } catch (refreshError) {
          // Refresh th·∫•t b·∫°i ‚Üí redirect login
          redirectToLogin('Session expired. Please login again.');
          return null;
        }
      }

      return response;
    } catch (error) {
      console.error('Request failed:', error);
      throw error;
    }
  }

  function setupTokenAutoRefresh() {
    // Refresh token 2 ph√∫t tr∆∞·ªõc khi h·∫øt h·∫°n (15 ph√∫t - 2 ph√∫t = 13 ph√∫t)
    const refreshInterval = (15 - 2) * 60 * 1000; // 13 ph√∫t

    setInterval(async () => {
      try {
        const token = sessionStorage.getItem('authToken');
        if (token) {
          console.log('Auto-refreshing token...');
          await refreshAccessToken();
        }
      } catch (error) {
        console.log('Auto-refresh failed, user will need to login again');
      }
    }, refreshInterval);
  }

  window.addEventListener('load', function() {
    loadUserData();
    setupTokenAutoRefresh(); // B·∫≠t auto-refresh
  });

  document.getElementById('logoutBtn').addEventListener('click', function (e) {
    e.preventDefault();

    // Confirm tr∆∞·ªõc khi logout
    if (confirm('Are you sure you want to logout?')) {
      logout();
    }
  });

  // Ki·ªÉm tra session storage c√≥ b·ªã thay ƒë·ªïi kh√¥ng (optional)
  window.addEventListener('storage', function (e) {
    if (e.key === 'authToken' && !e.newValue) {
      // Token b·ªã x√≥a t·ª´ tab kh√°c
      redirectToLogin('You have been logged out from another tab');
    }
  });

  // Ki·ªÉm tra session khi focus v√†o window (optional)
  window.addEventListener('focus', function () {
    const token = sessionStorage.getItem('authToken');
    if (!token && window.userData) {
      redirectToLogin('Session expired');
    }
  });

  document.getElementById('openFileManagerBtn').addEventListener('click', function() {
    const token = sessionStorage.getItem('authToken');
    const username = sessionStorage.getItem('username');

    if (!token || !username) {
      alert('Please login first');
      return;
    }

    // T·∫°o URL v·ªõi token v√† user info
    const angularUrl = `http://localhost:4200/file-manager?token=${encodeURIComponent(token)}&username=${encodeURIComponent(username)}`;

    // M·ªü trong tab m·ªõi
    window.open(angularUrl, '_blank');
  });
</script>
</body>
</html>